#include "stm32f4xx.h" // ??????STM32F4??????????????????????
#include "FreeRTOS.h"
#include "task.h"
#include "key.h"
#include "delay.h"
#include "dht11.h"
#include "oled.h"
#include "rtc_date.h"
#include "led.h"
#include <string.h>
#include <stdio.h>
#include "queue.h"
#include "debug.h"
#include "hooks.h"

TaskHandle_t Handle_dht11;
TaskHandle_t Handle_OLED;

QueueHandle_t xDataQueue;

static void data_task(void *pvParameters);

int main(void)
{
    debug_init();
    printf("debug_init\n");
    // NVIC??????4
    NVIC_PriorityGroupConfig(NVIC_PriorityGroup_4);
    printf("NVIC_PriorityGroupConfig\n");
    // TIM6_Delay_Init();
    // printf("TIM6_Delay_Init");
    LED_Init();      // LED??????
        // ????????????printf
    RTC_Date_Init(); // rtc???????
    DHT11_Init();    // DHT11??????
    KEY_Init();      // ????????????

    
    // ??????????????????????????
    xDataQueue = xQueueCreate(10, sizeof(uint8_t));
    printf("main:%p\n", xDataQueue);
    xTaskCreate(data_task,                 // ??????????????
                (const char *)"data_task", // ?????????????????????????
                512,                       // ?????????????(???????????4????????
                NULL,       // ??????????????????
                1,                         // ???????
                &Handle_dht11);            // ?????????
    /* ????????????????? */
    vTaskStartScheduler();
}

static void data_task(void *pvParameters)
{
    LED_Set_All(1);
    uint8_t buffer[50] = {0};
    uint8_t index = 0;
    printf("data_task\n");
    while (1)
    {
        uint8_t ch;
        xQueueReceive(xDataQueue, &ch, portMAX_DELAY);

        if (index < sizeof(buffer) - 1)
        {
            buffer[index++] = ch;
            buffer[index] = '\0'; // ??????'\0'??
        }
        printf("%c", ch);  // ???????????????????

        if (strstr((char *)buffer, "hello"))
        {
            LED1 = !LED1;
        }
        if (strstr((char *)buffer, "world"))
        {
            LED2 = !LED2;
        }

        // ?????????????
        if (ch == '\r' || ch == '\n')
        {
            index = 0;
            buffer[0] = '\0';
        }
    }
}
