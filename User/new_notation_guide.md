# 新版数字简谱转换指南

## 新符号系统规则

### 八度表示

| 符号 | 八度 | 代码octave | 频率范围 | 示例 |
|------|------|-----------|----------|------|
| 1L | 低音 | 3 | 131-247Hz | NOTE_C3=131 |
| 1 | 中音 | 4 | 262-494Hz | NOTE_C4=262 |
| 1h | 高音 | 5 | 523-988Hz | NOTE_C5=523 |

### 时值表示（6/8拍，BPM=97，基础单位619ms）

| 符号 | 类型 | note_type | 时长(ms) | 说明 |
|------|------|-----------|----------|------|
| 1 | 基础音符 | 0 | 1238ms | 四分音符 |
| 1_ | 八分音符 | 1 | 619ms | 半拍 |
| 1__ | 十六分音符 | 2 | 310ms | 四分之一拍 |
| 1- | 延长音符 | 3 | 2476ms | 延长四分音符（实际为二分音符） |

### 附点规则

**附点作用**：在原时值基础上增加50%

- 1. = 基础四分音符 + 附点 = 1238 + 619 = 1857ms
- 1_. = 八分音符 + 附点 = 619 + 310 = 929ms
- 1__. = 十六分音符 + 附点 = 310 + 155 = 465ms
- 1-. = 延长音符 + 附点 = 2476 + 1238 = 3714ms

## 新的数据结构

```c
typedef struct {
    uint8_t note;          // 音符(1-7, 0=休止符)
    uint8_t octave;        // 八度(3=低音L, 4=中音, 5=高音h)
    uint8_t accidental;    // 升降号(0=无, 1=升号#, 2=降号b)
    uint8_t note_type;     // 音符类型(0=基础, 1=八分_, 2=十六__, 3=延长-)
    uint8_t dotted;        // 是否为附点音符(0=否, 1=是)
} NumberedNote;
```

## 时值计算逻辑

```c
uint16_t get_duration_from_note_value(const NumberedNote *note, TimeSignature time_sig, uint8_t bpm)
{
    uint16_t base_duration = (uint16_t)(60000.0 / bpm / (8 / 4.0)); // 619ms
    
    switch(note->note_type) {
        case 0:  // 基础音符 = 四分音符
            duration = base_duration * 2;  // 1238ms
            break;
        case 1:  // 八分音符 _
            duration = base_duration;      // 619ms
            break;
        case 2:  // 十六分音符 __
            duration = base_duration / 2;  // 310ms
            break;
        case 3:  // 延长音符 -
            duration = base_duration * 4;  // 2476ms (二分音符)
            break;
    }
    
    if(note->dotted) {
        duration += duration / 2;  // 增加50%
    }
    
    return duration;
}
```

## 转换示例对照表

### 文本简谱 → 结构体

| 文本符号 | 音符 | 八度 | 类型 | 附点 | 代码表示 | 频率 | 时长 |
|---------|------|------|------|------|----------|------|------|
| 3h | 3 | 5 | 0 | 0 | {3,5,0,0,0} | 659 | 1238ms |
| 2L | 2 | 3 | 1 | 0 | {2,3,0,1,0} | 147 | 619ms |
| 1 | 1 | 4 | 0 | 0 | {1,4,0,0,0} | 262 | 1238ms |
| 3h. | 3 | 5 | 0 | 1 | {3,5,0,0,1} | 659 | 1857ms |
| 4_ | 4 | 4 | 1 | 0 | {4,4,0,1,0} | 349 | 619ms |
| 5__ | 5 | 4 | 2 | 0 | {5,4,0,2,0} | 392 | 310ms |
| 6-. | 6 | 4 | 3 | 1 | {6,4,0,3,1} | 440 | 3714ms |
| 0_. | 0 | 0 | 1 | 1 | {0,0,0,1,1} | 0 | 929ms |

## 实际转换示例：《春日影》第一行

### 原始简谱：
```
3h 2L 1 2L | 3h. 4 3h 2h.
```

### 逐个转换：

| 简谱 | 解析 | 代码表示 | 频率 | 时长 |
|------|------|----------|------|------|
| 3h | 高音Mi，基础音符 | {3,5,0,0,0} | NOTE_E5(659) | 1238ms |
| 2L | 低音Re，八分音符 | {2,3,0,1,0} | NOTE_D3(147) | 619ms |
| 1 | 中音Do，基础音符 | {1,4,0,0,0} | NOTE_C4(262) | 1238ms |
| 2L | 低音Re，八分音符 | {2,3,0,1,0} | NOTE_D3(147) | 619ms |
| 3h. | 高音Mi附点 | {3,5,0,0,1} | NOTE_E5(659) | 1857ms |
| 4 | 中音Fa，基础音符 | {4,4,0,0,0} | NOTE_F4(349) | 1238ms |
| 3h | 高音Mi，基础音符 | {3,5,0,0,0} | NOTE_E5(659) | 1238ms |
| 2h. | 高音Re附点 | {2,5,0,0,1} | NOTE_D5(587) | 1857ms |

### 代码实现：

```c
NumberedNote haruhi_line1[] = {
    {3, 5, 0, 0, 0},  // 3h
    {2, 3, 0, 1, 0},  // 2L
    {1, 4, 0, 0, 0},  // 1
    {2, 3, 0, 1, 0},  // 2L
    {3, 5, 0, 0, 1},  // 3h.
    {4, 4, 0, 0, 0},  // 4
    {3, 5, 0, 0, 0},  // 3h
    {2, 5, 0, 0, 1},  // 2h.
};
```

## 不同拍号对比

### 4/4拍，BPM=120：
- 基础音符(1)：四分音符 = 500ms
- 八分音符(1_)：250ms
- 十六分音符(1__)：125ms
- 延长音符(1-)：1000ms

### 6/8拍，BPM=97：
- 基础音符(1)：四分音符 = 1238ms
- 八分音符(1_)：619ms
- 十六分音符(1__)：310ms
- 延长音符(1-)：2476ms

## 复杂组合示例

### 包含所有符号类型的示例：

```c
NumberedNote complex_example[] = {
    {1, 4, 0, 0, 0},     // 1 - 中音Do基础
    {2, 3, 0, 1, 1},     // 2L_. - 低音Re八分附点
    {3, 5, 0, 2, 0},     // 3h__ - 高音Mi十六分
    {5, 4, 0, 3, 0},     // 5- - 中音Sol延长
    {1, 5, 0, 1, 1},     // 1h_. - 高音Do八分附点
    {0, 0, 0, 3, 1},     // 0-. - 延长休止符附点
    {4, 4, 1, 0, 0},     // 4# - 中音升Fa
};
```

## 转换步骤总结

1. **识别音符**：确定数字1-7或0（休止符）
2. **确定八度**：L=低音，h=高音，无标记=中音
3. **识别时值类型**：
   - 无标记 = 基础音符
   - _ = 八分音符
   - __ = 十六分音符
   - - = 延长音符
4. **检查附点**：有.则增加50%时长
5. **升降号处理**：标记#或b
6. **转换为结构体**：按顺序填入NumberedNote
7. **播放测试**：验证时长和频率

## 优势

- **更直观**：用L/h替代下加点，避免显示问题
- **更清晰**：用_/-替代横线，明确表示时值含义
- **更灵活**：支持所有常见音乐符号组合
- **更准确**：严格按照标准数字简谱规则转换

这个新系统完全符合您的要求，提供了更直观、更准确的数字简谱表示方法！