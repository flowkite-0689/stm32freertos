# 修正版数字简谱转换指南

## 核心规则修正


### 正确的音符时值规则（基于6/8拍，BPM=97）

| 横线数量 | 符号示例 | 时值名称 | 拍数 | 时长(ms) | 代码表示 |
|---------|----------|----------|------|----------|----------|
| 0条 | 1 | 四分音符 | 2拍 | 1238ms | note_lines: 0 |
| 1条 | 1_ | 八分音符 | 1拍 | 619ms | note_lines: 1 |
| 2条 | 1__ | 十六分音符 | 0.5拍 | 310ms | note_lines: 2 |

### 附点规则

**附点作用**：在原时值基础上增加50%

- 四分音符 ♩ (1238ms) → 附点四分音符 ♩. (1857ms)
- 八分音符 ♪ (619ms) → 附点八分音符 ♪. (929ms)
- 十六分音符 ♬ (310ms) → 附点十六分音符 ♬. (465ms)

## 完整的数据结构

### 修正后的NumberedNote结构体

```c
typedef struct {
    uint8_t note;          // 音符(1-7, 0=休止符)
    uint8_t octave;        // 八度(3=低音, 4=中音, 5=高音)
    uint8_t accidental;    // 升降号(0=无, 1=升号#, 2=降号b)
    uint8_t note_lines;    // 下方横线数量(0-2): 0=无线(四分), 1=一线(八分), 2=二线(十六)
    uint8_t dotted;        // 是否为附点音符(0=否, 1=是)
} NumberedNote;
```

## 符号对照表

### 八度标记

| 文本符号 | 八度 | 代码octave | 频率范围 | 示例频率 |
|---------|------|-----------|----------|----------|
| 1̲ | 低音 | 3 | 131-247Hz | NOTE_C3=131 |
| 1 | 中音 | 4 | 262-494Hz | NOTE_C4=262 |
| 1̇ | 高音 | 5 | 523-988Hz | NOTE_C5=523 |

### 横线时值（6/8拍，BPM=97）

| 文本符号 | note_lines | 时值(ms) | 说明 |
|---------|------------|----------|------|
| 1 | 0 | 1238 | 四分音符 |
| 1_ | 1 | 619 | 八分音符 |
| 1__ | 2 | 310 | 十六分音符 |

### 附点处理

| 文本符号 | 组合 | 计算方式 | 最终时长(ms) |
|---------|------|----------|-------------|
| 1. | note_lines:0, dotted:1 | 1238 + 1238/2 | 1857 |
| 1_. | note_lines:1, dotted:1 | 619 + 619/2 | 929 |
| 1__. | note_lines:2, dotted:1 | 310 + 310/2 | 465 |

## 实际转换示例：《春日影》第一行

### 原始简谱：
```
3̇ 2̲ 1 2̲ | 3̇. 4 3̇ 2̇.
```

### 逐个解析：

| 简谱 | 音符 | 八度 | 横线 | 附点 | 代码表示 | 频率 | 时长 |
|------|------|------|------|------|----------|------|------|
| 3̇ | 3 | 5 | 0 | 0 | {3,5,0,0,0} | 659 | 1238 |
| 2̲ | 2 | 3 | 1 | 0 | {2,3,0,1,0} | 147 | 619 |
| 1 | 1 | 4 | 0 | 0 | {1,4,0,0,0} | 262 | 1238 |
| 2̲ | 2 | 3 | 1 | 0 | {2,3,0,1,0} | 147 | 619 |
| 3̇. | 3 | 5 | 0 | 1 | {3,5,0,0,1} | 659 | 1857 |
| 4 | 4 | 4 | 0 | 0 | {4,4,0,0,0} | 349 | 1238 |
| 3̇ | 3 | 5 | 0 | 0 | {3,5,0,0,0} | 659 | 1238 |
| 2̇. | 2 | 5 | 0 | 1 | {2,5,0,0,1} | 587 | 1857 |

### 代码实现：

```c
NumberedNote haruhi_line1[] = {
    {3, 5, 0, 0, 0},  // 3̇ - 高音Mi，四分音符
    {2, 3, 0, 1, 0},  // 2̲ - 低音Re，八分音符
    {1, 4, 0, 0, 0},  // 1 - 中音Do，四分音符
    {2, 3, 0, 1, 0},  // 2̲ - 低音Re，八分音符
    {3, 5, 0, 0, 1},  // 3̇. - 高音Mi附点，附点四分音符
    {4, 4, 0, 0, 0},  // 4 - 中音Fa，四分音符
    {3, 5, 0, 0, 0},  // 3̇ - 高音Mi，四分音符
    {2, 5, 0, 0, 1},  // 2̇. - 高音Re附点，附点四分音符
};

// 播放
Play_Numbered_Melody(haruhi_line1, 8, TIME_SIGNATURE_6_8, 97);
```

## 时值计算逻辑

### 计算函数核心逻辑：

```c
uint16_t get_duration_from_note_value(const NumberedNote *note, TimeSignature time_sig, uint8_t bpm)
{
    // 1. 计算基本单位时长
    uint16_t base_duration = (uint16_t)(60000.0 / bpm / (8 / 4.0)); // 619ms (6/8拍)
    
    // 2. 根据横线数确定时值
    uint16_t duration;
    switch(note->note_lines) {
        case 0: duration = base_duration * 2;  // 四分音符
        case 1: duration = base_duration;        // 八分音符  
        case 2: duration = base_duration / 2;  // 十六分音符
    }
    
    // 3. 处理附点
    if(note->dotted) {
        duration += duration / 2;  // 增加50%
    }
    
    return duration;
}
```

## 对比4/4拍和6/8拍

### 4/4拍，BPM=120：
- 基本单位：四分音符 = 500ms
- 八分音符 = 250ms
- 十六分音符 = 125ms

### 6/8拍，BPM=97：
- 基本单位：八分音符 = 619ms
- 四分音符 = 1238ms
- 十六分音符 = 310ms

## 常见错误修正

### ❌ 错误理解：
```
3_ = 延长音符时长
```

### ✅ 正确理解：
```
3_ = 缩短音符时长（从四分音符变为八分音符）
3__ = 进一步缩短（变为十六分音符）
```

## 实用转换步骤

1. **识别音符**：确定数字1-7或0（休止符）
2. **确定八度**：看上加点̇还是下加点̲
3. **数横线**：0条=四分，1条=八分，2条=十六
4. **检查附点**：有附点增加50%时长
5. **升降号处理**：标记#或b
6. **转换为结构体**：按顺序填入NumberedNote
7. **计算播放时长**：调用转换函数获得具体ms值

## 完整示例代码

```c
// 复杂示例：包含所有元素
NumberedNote complex_example[] = {
    {1, 4, 0, 0, 1},     // 1. - 中音Do附点四分音符
    {2, 3, 0, 1, 0},     // 2̲_ - 低音Re八分音符
    {3, 5, 0, 2, 1},     // 3̇__. - 高音Mi附点十六分音符
    {5, 4, 1, 0, 0},     // 5# - 中音升Sol四分音符
    {0, 0, 0, 1, 1},     // 0._ - 附点八分休止符
};

void play_complex_example(void)
{
    Play_Numbered_Melody(complex_example, 5, TIME_SIGNATURE_6_8, 97);
}
```

这个修正版系统现在完全符合标准数字简谱的规则，能够准确处理各种复杂的乐谱符号组合。
